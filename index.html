<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>REKAT â€” Portal Login & Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }
  .view-container { transition: opacity 0.3s ease-in-out; }
  .glass-input { @apply bg-white/50 border border-blue-200/50 shadow-inner text-gray-800 placeholder-gray-500 transition duration-150; }
  .flex-1\.3 { flex: 1.3; }
  
  /* Initial view state to prevent flash of content */
  #view-profile-setup, #view-dashboard, #view-loading { display: none; opacity: 0; }
  #view-auth { display: block; opacity: 1; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-sky-50 to-indigo-100 p-4 sm:p-6 font-sans">

  <!-- Main Application Container -->
  <div id="app-container" class="flex flex-col md:flex-row w-full max-w-4xl bg-white/70 backdrop-blur-xl rounded-2xl shadow-2xl overflow-hidden">
    
    <!-- Left Panel: Brand -->
    <div class="flex-1 bg-blue-700 bg-gradient-to-br from-blue-800 to-blue-600 text-white p-8 flex flex-col justify-center shadow-lg">
      <div class="text-3xl font-extrabold mb-2">REKAT</div>
      <div class="text-xl font-semibold opacity-95">Ruang Edukasi Kolaborasi Aktivitas</div>
      <p class="text-sm opacity-80 mt-4 border-t border-white/30 pt-4">
        Platform terintegrasi untuk mendukung aktivitas edukasi, kolaborasi, dan manajemen data.
      </p>
    </div>

    <!-- Right Panel: Dynamic Content -->
    <div class="flex-1\.3 p-8 relative">
      <h1 id="mainTitle" class="text-2xl font-bold mb-6 text-gray-800">Masuk atau Daftar ke Portal REKAT</h1>

      <!-- 1. AUTH VIEW (LOGIN/REGISTER) -->
      <div id="view-auth" class="view-container">
        <div id="form-login" class="space-y-4">
          <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200">Masuk</button>
          <button id="showRegister" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold p-3 rounded-lg border border-gray-300 transition duration-150">Belum punya akun? Daftar</button>
        </div>
        <div id="form-register" class="hidden space-y-4">
          <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <input type="password" id="regPassword" placeholder="Password (min 6 karakter)" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <input type="password" id="regPassword2" placeholder="Ulangi Password" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <button id="btnRegister" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200">Daftar Sekarang</button>
          <button id="showLogin" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold p-3 rounded-lg border border-gray-300 transition duration-150">Sudah punya akun? Masuk</button>
        </div>
      </div>

      <!-- 2. PROFILE SETUP VIEW -->
      <div id="view-profile-setup" class="view-container">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Lengkapi Profil</h2>
        <div class="space-y-4">
          <p class="text-gray-600 text-sm">Anda hanya perlu mengisi ini sekali.</p>
          <input type="text" id="setupName" placeholder="Nama Lengkap" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <select id="setupRole" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input appearance-none">
            <option value="" disabled selected>Pilih Peran Anda</option>
            <option>Guru Mapel</option><option>Staf TU</option><option>Sarana & Prasarana</option>
            <option>Kurikulum</option><option>Kesiswaan</option><option>Bendahara</option><option>KTU</option>
          </select>
          <button id="saveSetupProfile" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200">Simpan Profil & Lanjutkan</button>
        </div>
      </div>

      <!-- 3. DASHBOARD VIEW -->
      <div id="view-dashboard" class="view-container">
        <div id="profileView" class="space-y-6">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Ringkasan Profil</h2>
          <div class="flex items-center gap-4 border border-blue-400/30 p-4 rounded-xl bg-blue-50/70 shadow-inner">
            <div id="profilePhotoContainer" class="w-20 h-20 rounded-full overflow-hidden flex items-center justify-center bg-blue-600 text-white shadow-lg flex-shrink-0">
              <div id="profilePhotoInitial" class="font-bold text-3xl">U</div>
            </div>
            <div class="flex-grow">
              <div id="displayName" class="font-bold text-xl text-gray-800"></div>
              <div id="displayRole" class="text-md text-blue-700 font-semibold"></div>
              <div id="displayEmail" class="text-sm text-gray-500 mt-1"></div>
            </div>
          </div>
          <div class="text-xs text-gray-500 border-t pt-2 border-blue-200/50">
            User ID (Kolaborasi): <code id="userIdDisplay" class="font-mono text-xs bg-gray-100/70 p-1 rounded-md break-all"></code>
          </div>
          <button id="editProfileBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200 mt-4">Ubah Profil</button>
          <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200">Keluar (Logout)</button>
        </div>

        <div id="profileEdit" class="hidden space-y-4">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Edit Profil</h2>
          <input type="text" id="profileNameInput" placeholder="Nama Lengkap" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input">
          <select id="profileRoleInput" class="w-full p-3 border rounded-lg focus:ring-blue-500 glass-input appearance-none">
            <option value="" disabled selected>Pilih Peran</option>
            <option value="Guru Mapel">Guru Mapel</option><option value="Staf TU">Staf TU</option><option value="Sarana & Prasarana">Sarana & Prasarana</option>
            <option value="Kurikulum">Kurikulum</option><option value="Kesiswaan">Kesiswaan</option><option value="Bendahara">Bendahara</option><option value="KTU">KTU</option>
          </select>
          <label for="profilePhotoInput" class="block w-full text-center bg-gray-200/50 hover:bg-gray-200 text-gray-700 font-semibold p-3 rounded-lg border border-gray-300 cursor-pointer transition duration-150">
            Pilih Foto Profil Baru (Maks 5MB)
          </label>
          <input type="file" id="profilePhotoInput" accept="image/*" class="hidden">
          <div id="fileNameDisplay" class="text-sm text-gray-500 truncate">Belum ada file dipilih.</div>
          <button id="saveProfileBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold p-3 rounded-lg shadow-md transition duration-200">Simpan Perubahan</button>
          <button id="cancelEditBtn" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold p-3 rounded-lg transition duration-150">Batal</button>
        </div>
      </div>

      <!-- 4. LOADING VIEW (Z-index high to prevent layering issues) -->
      <div id="view-loading" class="view-container text-center p-10 absolute inset-0 bg-white/50 backdrop-blur-sm flex flex-col items-center justify-center rounded-lg z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p id="dynamicLoadingMessage" class="text-gray-600 font-semibold">Menghubungkan ke server...</p>
      </div>

    </div> <!-- End of Right Panel -->
  </div> <!-- End of Main Container -->

  <!-- Global Message Modal -->
  <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
      <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
        <h4 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">Pesan!</h4>
        <p id="messageText" class="text-gray-700 mb-6"></p>
        <button id="closeModal" class="w-full bg-blue-500 text-white font-semibold p-3 rounded-lg">Tutup</button>
      </div>
  </div>

<script type="module">
// --- CONFIGURATION & FIREBASE SETUP ---
// Variabel global yang disediakan oleh lingkungan Canvas (HARUS digunakan).
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Mengimpor modul Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// Inisialisasi Firebase. Ini adalah baris di mana kegagalan konfigurasi (API Key) akan terjadi.
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
setLogLevel('Debug');

// --- GLOBAL STATE & UTILITIES ---
const $ = id => document.getElementById(id);
const views = ['view-loading', 'view-auth', 'view-profile-setup', 'view-dashboard'];
let currentUser = null;
let currentUserDoc = null;
let selectedFile = null;
let isAuthReady = false; 

// Utilitas untuk pesan loading dinamis
let loadingInterval = null;
const dynamicMessages = ["Menghubungkan ke server...", "Memeriksa status otentikasi...", "Memuat data profil..."];
let messageIndex = 0;

function startLoadingAnimation() {
    const messageEl = $('dynamicLoadingMessage');
    if (!messageEl) return;
    clearInterval(loadingInterval);
    messageIndex = 0;
    loadingInterval = setInterval(() => {
        messageEl.textContent = dynamicMessages[messageIndex];
        messageIndex = (messageIndex + 1) % dynamicMessages.length;
    }, 1500); 
}

function stopLoadingAnimation() {
    clearInterval(loadingInterval);
    loadingInterval = null;
}

/**
 * Mengganti tampilan aplikasi dengan animasi.
 */
function showView(targetViewId, title) {
    $('mainTitle').textContent = title;
    
    if (targetViewId !== 'view-loading') { stopLoadingAnimation(); }

    views.forEach(viewId => {
        const el = $(viewId);
        if (el) {
            el.style.display = 'none';
            el.style.opacity = 0;
        }
    });

    const targetEl = $(targetViewId);
    if (targetEl) {
        targetEl.style.display = (targetViewId === 'view-loading' ? 'flex' : 'block');
        setTimeout(() => { targetEl.style.opacity = 1; }, 10);
        if (targetViewId === 'view-loading') { startLoadingAnimation(); } 
    }
}

/**
 * Menampilkan pesan menggunakan modal kustom (bukan alert/confirm).
 */
function showMessage(title, text, isError = true) {
  const modal = $("messageModal");
  const titleEl = $("messageTitle");
  
  titleEl.textContent = title;
  titleEl.classList.toggle('text-red-600', isError);
  titleEl.classList.toggle('text-green-600', !isError);
  $("messageText").textContent = text;
  
  modal.classList.remove('hidden', 'opacity-0');
  modal.classList.add('flex', 'opacity-100');
  modal.querySelector('div').classList.remove('scale-95');
  modal.querySelector('div').classList.add('scale-100');
}

$("closeModal").onclick = () => {
  const modal = $("messageModal");
  modal.classList.remove('opacity-100');
  modal.querySelector('div').classList.remove('scale-100');
  modal.querySelector('div').classList.add('scale-95');
  setTimeout(() => {
    modal.classList.remove('flex');
    modal.classList.add('hidden', 'opacity-0');
  }, 300);
};

// --- FIREBASE PATHS ---
// Path untuk dokumen profil pengguna (data private)
const getProfileDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'profile'); 
// Path untuk penyimpanan foto profil
const getAvatarStorageRef = (uid, filename) => storageRef(storage, `artifacts/${appId}/avatars/${uid}/${filename}`);

// --- AUTH AND PROFILE LOGIC ---

/**
 * Memuat dokumen profil pengguna dari Firestore.
 */
async function loadUserDoc(uid) {
  if (!isAuthReady) return false; 
  try {
    const snap = await getDoc(getProfileDocRef(uid));
    if (snap.exists()) {
      currentUserDoc = snap.data();
      $('userIdDisplay').textContent = uid;
      $('displayName').textContent = currentUserDoc.name || 'Nama Tidak Diatur';
      $('displayRole').textContent = currentUserDoc.role || 'Peran Tidak Diatur';
      $('displayEmail').textContent = currentUser.email;

      // Menampilkan foto atau inisial
      const container = $('profilePhotoContainer');
      container.innerHTML = '';
      if (currentUserDoc.photoURL) {
        container.style.backgroundColor = 'transparent';
        container.innerHTML = `<img src="${currentUserDoc.photoURL}" alt="${currentUserDoc.name || 'User'}'s profile photo" class="w-full h-full object-cover">`;
      } else {
        container.style.backgroundColor = '#2563EB';
        container.innerHTML = `<div id="profilePhotoInitial" class="font-bold text-3xl">${currentUserDoc.name ? currentUserDoc.name[0].toUpperCase() : 'U'}</div>`;
      }
      return true;
    }
    return false;
  } catch (e) {
    console.error("Gagal memuat data profil:", e);
    return false;
  }
}

/**
 * Menentukan tampilan yang akan dimuat setelah autentikasi.
 */
async function renderApp(user) {
    if (!isAuthReady) return; 

    // Jika pengguna terautentikasi dan BUKAN anonim
    if (user && !user.isAnonymous) {
        currentUser = user;
        showView('view-loading', 'Memeriksa Profil...');

        const profileExists = await loadUserDoc(user.uid);

        if (profileExists) {
            showView('view-dashboard', 'Dashboard Profil Saya');
        } else {
            showView('view-profile-setup', 'Lengkapi Profil Anda');
        }
    } else {
        // Tampilkan Auth View jika tidak ada pengguna login (atau hanya anonim)
        showView('view-auth', 'Masuk atau Daftar ke Portal REKAT');
        $('form-login').classList.remove('hidden');
        $('form-register').classList.add('hidden');
    }
}

// Listener perubahan status autentikasi
onAuthStateChanged(auth, (user) => {
    if(isAuthReady) {
        renderApp(user);
    }
});

// --- INITIAL AUTHENTICATION CHECK ---
async function setupInitialAuth() {
    try {
        // Menggunakan session persistence
        await setPersistence(auth, browserSessionPersistence); 
        isAuthReady = true;

        if (auth.currentUser) {
            // Pengguna sudah login di session sebelumnya
            renderApp(auth.currentUser);
        } else if (initialAuthToken) {
            // Menggunakan custom token yang disediakan lingkungan
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            // Menggunakan sign-in anonim jika tidak ada token
            await signInAnonymously(auth); 
        }
        
    } catch (error) {
        // PENTING: Penanganan kegagalan inisialisasi (termasuk error API Key)
        console.error("Initial authentication failed (Environment Error - Check API Key):", error);
        isAuthReady = true; 
        showMessage("Kesalahan Lingkungan", "Gagal menyambung ke server. Harap cek API Key di konsol. Anda dapat login manual.", true);
        showView('view-auth', 'Masuk atau Daftar ke Portal REKAT'); 
    }
}
setupInitialAuth();


// --- EVENT HANDLERS ---
$('showRegister').onclick = () => {
    $('form-login').classList.add('hidden');
    $('form-register').classList.remove('hidden');
    $('mainTitle').textContent = 'Daftar Akun Baru';
};
$('showLogin').onclick = () => {
    $('form-register').classList.add('hidden');
    $('form-login').classList.remove('hidden');
    $('mainTitle').textContent = 'Masuk ke Portal REKAT';
};

$('btnRegister').onclick = async () => {
    const email = $('regEmail').value.trim();
    const p1 = $('regPassword').value;
    const p2 = $('regPassword2').value;
    
    if (!email || !p1 || !p2) return showMessage("Data Belum Lengkap", "Harap isi semua kolom pendaftaran.");
    if (p1.length < 6) return showMessage("Password Lemah", "Password harus memiliki minimal 6 karakter.");
    if (p1 !== p2) return showMessage("Password Tidak Sama", "Password yang Anda masukkan tidak cocok.");
    
    try {
      showView('view-loading', 'Mendaftar...');
      await createUserWithEmailAndPassword(auth, email, p1);
    } catch (e) {
      showMessage("Gagal Mendaftar", e.message);
      showView('view-auth', 'Masuk atau Daftar ke Portal REKAT');
      $('form-register').classList.remove('hidden');
    }
}

$('btnLogin').onclick = async () => {
    const email = $('loginEmail').value.trim();
    const p = $('loginPassword').value;
    
    if (!email || !p) return showMessage("Data Belum Lengkap", "Harap isi Email dan Password untuk masuk.");

    try {
      showView('view-loading', 'Masuk...');
      await signInWithEmailAndPassword(auth, email, p);
    } catch (e) {
      showMessage("Login Gagal", "Email atau Password salah. Cek kembali kredensial Anda. (" + e.message + ")");
      showView('view-auth', 'Masuk atau Daftar ke Portal REKAT');
      $('form-login').classList.remove('hidden');
    }
}

$('saveSetupProfile').onclick = async () => {
  const name = $('setupName').value.trim();
  const role = $('setupRole').value;
  if (!name || !role) return showMessage("Data Belum Lengkap", "Harap isi Nama Lengkap dan pilih Peran Anda.");
  
  $('saveSetupProfile').textContent = 'Menyimpan...';
  $('saveSetupProfile').disabled = true;

  try {
    const profileData = { name, role, email: auth.currentUser.email, createdAt: new Date().toISOString(), photoURL: null };
    // Simpan data profil ke Firestore
    await setDoc(getProfileDocRef(auth.currentUser.uid), profileData, { merge: true });
    
    showMessage("Profil Disimpan", "Selamat datang di Portal REKAT!", false);
    await renderApp(auth.currentUser); // Muat ulang UI untuk menampilkan dashboard
  } catch (e) {
    showMessage("Gagal Simpan Profil", e.message);
  } finally {
    $('saveSetupProfile').textContent = 'Simpan Profil & Lanjutkan';
    $('saveSetupProfile').disabled = false;
  }
}

// Edit Profile Handlers
$('editProfileBtn').onclick = () => {
  $('profileView').classList.add('hidden');
  $('profileEdit').classList.remove('hidden');
  $('mainTitle').textContent = 'Ubah Profil';
  $('profileNameInput').value = currentUserDoc.name || '';
  $('profileRoleInput').value = currentUserDoc.role || '';
  $('fileNameDisplay').textContent = "Belum ada file dipilih.";
  $('profilePhotoInput').value = null; 
  selectedFile = null;
};
$('cancelEditBtn').onclick = () => {
  $('profileEdit').classList.add('hidden');
  $('profileView').classList.remove('hidden');
  $('mainTitle').textContent = 'Dashboard Profil Saya';
  selectedFile = null;
};

// Handle pemilihan file foto
$('profilePhotoInput').addEventListener('change', e => {
  selectedFile = e.target.files[0];
  if (!selectedFile) {
    $('fileNameDisplay').textContent = "Belum ada file dipilih.";
    return;
  }
  // Batasi ukuran file
  if (selectedFile.size > 5 * 1024 * 1024) { 
    showMessage("Kesalahan File", "Ukuran file foto maksimal adalah 5MB."); 
    selectedFile = null;
    $('profilePhotoInput').value = null;
    $('fileNameDisplay').textContent = "Ukuran file terlalu besar!";
    return;
  }
  $('fileNameDisplay').textContent = selectedFile.name;
});

$('saveProfileBtn').onclick = async () => {
  const name = $('profileNameInput').value.trim();
  const role = $('profileRoleInput').value;
  if (!name || !role) return showMessage('Data Belum Lengkap', 'Harap isi Nama Lengkap dan pilih Peran Anda.');
  
  $('saveProfileBtn').textContent = 'Menyimpan...';
  $('saveProfileBtn').disabled = true;

  try {
    let photoURL = currentUserDoc.photoURL || null;
    if (selectedFile) {
      // Proses unggah foto ke Storage
      const path = `${Date.now()}_${selectedFile.name}`;
      const sRef = getAvatarStorageRef(currentUser.uid, path);
      const uploadTask = uploadBytesResumable(sRef, selectedFile);
      
      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed', 
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            $('saveProfileBtn').textContent = `Mengunggah... ${progress.toFixed(0)}%`;
          }, (error) => { console.error("Upload error:", error); reject(new Error("Gagal mengunggah foto.")); }, resolve);
      });
      // Dapatkan URL publik setelah unggah selesai
      photoURL = await getDownloadURL(uploadTask.snapshot.ref);
    }
    
    // Simpan perubahan nama, peran, dan URL foto ke Firestore
    await setDoc(getProfileDocRef(currentUser.uid), { name, role, email: currentUser.email, photoURL }, { merge: true });

    await loadUserDoc(currentUser.uid); // Muat ulang data untuk update dashboard
    $('profileEdit').classList.add('hidden');
    $('profileView').classList.remove('hidden');
    $('mainTitle').textContent = 'Dashboard Profil Saya';
    selectedFile = null;
    showMessage('Berhasil', 'Profil Anda berhasil diperbarui!', false);
    
  } catch (e) {
    showMessage('Gagal Menyimpan', e.message);
  } finally {
    $('saveProfileBtn').textContent = 'Simpan Perubahan';
    $('saveProfileBtn').disabled = false;
  }
};

$('logoutBtn').onclick = async () => { 
  try {
    await signOut(auth);
    showMessage("Berhasil Keluar", "Anda telah berhasil keluar dari REKAT.", false);
  } catch (e) {
    showMessage("Gagal Logout", e.message);
  }
};
</script>
</body>
</html>

